<div class="col-sm-12">
  <div class="card modern-card">
    <div class="card-body">
        <div class="page-header">
          <div>
            <h5 class="mb-1">Browse RFQs</h5>
            <p class="text-muted mb-0">Browse, filter and manage RFQs pending or validated.</p>
          </div>
          <div class="header-actions">
            <a routerLink="/rfq-manage/create-rfq" class="btn btn-primary add-rfq-btn" title="Add RFQ">
              <i class="feather icon-plus"></i>
              <span class="label">Add RFQ</span>
            </a>
          </div>
        </div>
      <div class="row align-items-center mb-3">
        <div class="col-md-6 status-toggle d-flex gap-2">
          <button class="btn btn-pending" [class.active]="currentFilter==='pending'" (click)="setFilter('pending')">Pending</button>
          <button class="btn btn-validated" [class.active]="currentFilter==='validated'" (click)="setFilter('validated')">Validated</button>
          <button class="btn" [class.active]="currentFilter==='brouillon'" (click)="setFilter('brouillon')" *ngIf="isValidator">Draft</button>
        </div>
        <div class="col-md-6">
          <div class="modern-search unified">
            <i class="feather icon-search"></i>
            <input type="text" class="form-control" placeholder="Search RFQs by id, CQ, quote, client" [(ngModel)]="searchText">
          </div>
        </div>
      </div>

      <div class="row align-items-center mb-2">
        <div class="col-md-6 sort-controls">
          <span class="sort-label"><i class="feather icon-sliders"></i> Sort</span>
          <select class="form-select sort-select" [(ngModel)]="sortKey">
            <option value="date">Creation Date</option>
            <option value="quoteName">Quote Name</option>
            <option value="rfqId">RFQ No.</option>
          </select>
          <input *ngIf="sortKey==='date'" type="date" class="form-control sort-date" [(ngModel)]="filterDate" placeholder="Filter by day" />
          <button class="btn sort-toggle" (click)="sortDir = sortDir==='asc' ? 'desc' : 'asc'">
            <i class="feather" [ngClass]="{'icon-arrow-up': sortDir==='asc', 'icon-arrow-down': sortDir==='desc'}"></i>
          </button>
        </div>
        <div class="col-md-6"></div>
      </div>

      <!-- Empty-state when no RFQs match -->
      <div *ngIf="getFilteredRFQsByStatus(currentFilter).length === 0" class="text-center py-5 text-muted">
        <i class="feather icon-inbox" style="font-size: 2rem;"></i>
        <div class="mt-2">No RFQs match your filters. Try adjusting status, search, or date.</div>
      </div>

      <!-- Card grid list -->
      <div class="row g-3">
        <div class="col-md-6 col-lg-4" *ngFor="let rfq of getFilteredRFQsByStatusPaginated(currentFilter); trackBy: trackTable">
          <div class="rfq-card h-100">
            <div class="rfq-card-header">
              <span class="rfq-title">RFQ No. {{ rfq.id }}</span>
              <span class="badge" [ngClass]="{
                'bg-warning text-dark': currentFilter==='pending',
                'bg-success': currentFilter==='validated',
                'badge-brouillon': currentFilter==='brouillon'
              }">{{ currentFilter==='pending' ? 'Pending' : (currentFilter==='validated' ? 'Validated' : 'Draft') }}</span>
            </div>
            <div class="rfq-meta">
              <span><strong>Quote:</strong> {{ rfq.quoteName || 'No quote name provided' }}</span>
              <span><strong>Client:</strong> {{ rfq.client || 'Unknown Client' }}</span>
              <span><strong>Created:</strong> {{ getFormattedDate(rfq.dateCreation) }}</span>
              <span><strong>CQ:</strong> {{ rfq.cq }}</span>
            </div>
            <div class="mt-2">
              <ng-container *ngIf="rfq.versionsCount && rfq.versionsCount > 0; else noVersions">
                <div class="version-dots">
                  <ng-container *ngIf="versionsByRFQ[rfq.id]?.length; else fallbackDots">
                    <span *ngFor="let v of versionsByRFQ[rfq.id]" class="version-dot" [ngClass]="getVersionDotClassForVersion(v)"></span>
                  </ng-container>
                  <ng-template #fallbackDots>
                    <span *ngFor="let _ of getVersionDots(rfq.versionsCount)" class="version-dot dot-yellow"></span>
                  </ng-template>
                </div>
              </ng-container>
              <ng-template #noVersions><div class="version-dots"><span class="version-dot dot-grey"></span></div></ng-template>
            </div>
            <div class="rfq-card-actions d-flex justify-content-end gap-2">
              <a class="icon-btn" [routerLink]="'/rfq-manage/get-rfq/' + rfq.id" title="View RFQ">
                <i class="feather icon-eye"></i>
              </a>
              <a class="icon-btn" *ngIf="isEngineer && currentFilter!=='validated'" [routerLink]="'/rfq-manage/edit-rfq/' + rfq.id" title="Edit RFQ">
                <i class="feather icon-edit"></i>
              </a>
              <a class="icon-btn text-danger" *ngIf="isAdmin" href="javascript:void(0)" (click)="delete(rfq.id)" title="Delete RFQ">
                <i class="feather icon-trash-2"></i>
              </a>
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-center mt-3">
        <ngb-pagination
          class="pagination-dark"
          [collectionSize]="getFilteredRFQsByStatus(currentFilter).length"
          [page]="getCurrentPage()"
          [pageSize]="pageSize"
          (pageChange)="setCurrentPage($event)"
          size="sm">
        </ngb-pagination>
      </div>
    </div>
  </div>
</div>
