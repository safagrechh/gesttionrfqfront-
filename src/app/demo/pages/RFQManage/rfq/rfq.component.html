<!-- Page Hero for View RFQ -->
<div class="row modern-page">
  <div class="col-12">
    <div class="section-card page-hero">
      <div class="hero-content">
        <div class="hero-left">
          <i class="feather icon-eye"></i>
          <div>
            <div class="hero-title">View RFQ</div>
            <div class="hero-subtitle">Review RFQ details, versions, and comments.</div>
          </div>
        </div>
        <div class="hero-actions">
          <a class="btn btn-outline-light back-expand-btn" [routerLink]="'/rfq-manage/get-rfqs'" aria-label="Back">
            <i class="feather icon-arrow-left"></i>
            <span class="label">Back</span>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Floating Actions: quick access for common RFQ actions -->
  <div class="floating-actions">
    <div class="floating-actions-inner">
    <!-- Download RFQ file when viewing RFQ -->
    <button *ngIf="rfq?.fileName" type="button" class="action-expand-btn" (click)="downloadFile(idrfq)" title="Download RFQ">
      <i class="feather icon-download-cloud"></i>
      <span class="label">Download RFQ</span>
    </button>

    <!-- Download Version file when a version is selected -->
    <button *ngIf="selectedVersion?.fileName" type="button" class="action-expand-btn" (click)="downloadFileV(selectedVersion.id)" title="Download Version">
      <i class="feather icon-download"></i>
      <span class="label">Download Version</span>
    </button>

    <!-- Validate RFQ when viewing RFQ (no version selected) -->
    <button *ngIf="!selectedVersion && isValidateur && !isBrouillon && rfq?.valide === false && rfq?.rejete === false"
            type="button" class="action-expand-btn success" (click)="onSubmitValider()" title="Valider RFQ">
      <i class="feather icon-check-circle"></i>
      <span class="label">Valider RFQ</span>
    </button>

    <!-- Validate Version when a version is selected -->
    <button *ngIf="selectedVersion && isValidateur && !isBrouillon && selectedVersion?.valide === false && selectedVersion?.rejete === false"
            type="button" class="action-expand-btn success" (click)="onSubmitValiderV()" title="Valider Version">
      <i class="feather icon-check-circle"></i>
      <span class="label">Valider Version</span>
    </button>

    <!-- Edit RFQ only when RFQ is displayed (no version selected) and not valid -->
  <a *ngIf="!selectedVersion && (isValidateur || isAdmin) && rfq?.valide === false" class="action-expand-btn warning" [routerLink]="'/rfq-manage/edit-rfq/' + idrfq" title="Edit RFQ">
      <i class="feather icon-edit"></i>
      <span class="label">Edit RFQ</span>
    </a>

    <!-- Edit Version (non-admin, when version not validated) -->
    <a *ngIf="selectedVersion && !isAdmin && !isBrouillon && selectedVersion?.valide === false"
       class="action-expand-btn warning"
       [routerLink]="'/rfq-manage/edit-version/' + idrfq +'/' + selectedVersion?.id"
       title="Edit Version">
      <i class="feather icon-edit"></i>
      <span class="label">Edit Version</span>
    </a>

    <!-- Add Version (same visibility case as Win/Lose buttons) -->
    <a *ngIf="!isAdmin && areAllVersionsValid() && rfqinitial?.valide && rfqinitial?.statut === null"
       class="action-expand-btn success" [routerLink]="'/rfq-manage/ajouter-version/' + idrfq" title="Add Version">
      <i class="feather icon-plus"></i>
      <span class="label">Add Version</span>
    </a>
    <button *ngIf="versions?.length >= 2 && !compareMode" type="button" class="action-expand-btn" (click)="enableCompare()" title="Compare Versions">
      <i class="feather icon-layers"></i>
      <span class="label">Compare</span>
    </button>
    <button *ngIf="compareMode" type="button" class="action-expand-btn danger" (click)="disableCompare()" title="Close Compare">
      <i class="feather icon-x"></i>
      <span class="label">Close Compare</span>
    </button>

    <!-- Win/Lose actions (only when RFQ valid and all versions valid, non-admin) -->
    <button *ngIf="!isAdmin && areAllVersionsValid() && rfqinitial?.valide && rfqinitial?.statut === null"
            type="button" class="action-expand-btn win" (click)="updateRFQStatus('win')" title="Win RFQ">
      <i class="feather icon-check-circle"></i>
      <span class="label">Win</span>
    </button>
    <button *ngIf="!isAdmin && areAllVersionsValid() && rfqinitial?.valide && rfqinitial?.statut === null"
            type="button" class="action-expand-btn danger" (click)="updateRFQStatus('lose')" title="Lose RFQ">
      <i class="feather icon-x-circle"></i>
      <span class="label">Lose</span>
    </button>

    <!-- Admin: Hide/Unhide selected version -->
    <button *ngIf="isAdmin && selectedVersion && !isVersionHidden(selectedVersion?.id)" type="button" class="action-expand-btn danger" (click)="toggleHideSelectedVersion()" title="Hide Version">
      <i class="feather icon-eye-off"></i>
      <span class="label">Hide Version</span>
    </button>
    <button *ngIf="isAdmin && selectedVersion && isVersionHidden(selectedVersion?.id)" type="button" class="action-expand-btn" (click)="toggleHideSelectedVersion()" title="Unhide Version">
      <i class="feather icon-eye"></i>
      <span class="label">Unhide Version</span>
    </button>
  </div>
</div>

<div class="container">
  <div class="col-sm-12">
    <div class="row section-card">

      <div class="workflow-container">
        <div class="rfq-title-bar rfq-title-bar--centered">
          <div class="title-icon"><i class="fas fa-stream"></i></div>
          <h3 class="rfq-title">RFQ N°{{ idrfq }} - Versions</h3>
          <div class="rfq-title-badges d-flex align-items-center gap-2">
            <span *ngIf="rfqinitial?.statut === 0" class="badge bg-success p-2">Won</span>
            <span *ngIf="rfqinitial?.statut === 1" class="badge bg-danger p-2">Lost</span>
            <div *ngIf="isAdmin" class="form-check form-switch ms-2 show-hidden-switch">
              <input class="form-check-input" type="checkbox" [checked]="showHidden" (change)="showHidden = $any($event.target).checked">
              <label class="form-check-label">Show hidden versions</label>
            </div>
          </div>
        </div>
        <div class="pipeline">
          <div class="pipeline-track"></div>
          <!-- RFQ Node -->
          <button type="button"
                  class="pipeline-step"
                  [class.valid]="rfqinitial?.valide"
                  [class.pending]="!rfqinitial?.valide && !rfqinitial?.rejete"
                  [class.rejected]="rfqinitial?.rejete"
                  [class.selected]="!selectedVersion"
                  (click)="onRFQClick()"
                  title="RFQ initial">
            <div class="pipeline-node">
              <i class="feather" [ngClass]="{
                'icon-check-circle': rfqinitial?.valide,
                'icon-x-circle': rfqinitial?.rejete,
                'icon-minus': !rfqinitial?.valide && !rfqinitial?.rejete
              }"></i>
            </div>
            <div class="pipeline-label">
              <div class="title">V{{ getVisibleCount() }}_{{ idrfq }}</div>
              <div class="subtitle">{{ rfqinitial?.valide ? 'Validé' : (rfqinitial?.rejete ? 'Rejeté' : 'En attente') }}</div>
            </div>
          </button>

          <!-- Version Nodes -->
          <button type="button"
                  class="pipeline-step"
                  *ngFor="let version of getVisibleVersions(); let i = index"
                  (click)="onVersionClick(version.id)"
                  [class.valid]="version?.valide"
                  [class.pending]="!version?.valide && !version?.rejete"
                  [class.rejected]="version?.rejete"
                  [class.hidden]="isAdmin && isVersionHidden(version?.id)"
                  [class.selected]="selectedVersion?.id === version?.id"
                  title="Version V{{ getDisplayNumberByIndex(i) }}">
            <div class="pipeline-node">
              <i class="feather" [ngClass]="{
                'icon-check-circle': version?.valide,
                'icon-x-circle': version?.rejete,
                'icon-minus': !version?.valide && !version?.rejete
              }"></i>
            </div>
            <div class="pipeline-label">
              <div class="title">V{{ getDisplayNumberByIndex(i) }}_{{ idrfq }}</div>
              <div class="subtitle">{{ version?.valide ? 'Validé' : (version?.rejete ? 'Rejeté' : 'En attente') }}</div>
            </div>
          </button>
        </div>

        <!-- <div *ngIf="!isAdmin  && areAllVersionsValid() " class="d-flex justify-content-end mb-3">
          <button *ngIf="rfqinitial?.valide && rfqinitial?.statut === null"
                  class="btn btn-success me-2"
                  (click)="updateRFQStatus('win')">
            <i class="feather icon-check-circle"></i> Win
          </button>
          <button *ngIf="rfqinitial?.valide && rfqinitial?.statut === null"
                  class="btn btn-danger me-2"
                  (click)="updateRFQStatus('lose')">
            <i class="feather icon-x-circle"></i> Lose
          </button>

          <a
             *ngIf="rfqinitial?.statut === null"
             [routerLink]="'/rfq-manage/ajouter-version/' + idrfq"
             class="btn btn-outline-success add-version-btn">
            <i class="feather icon-plus"></i> une nouvelle version
          </a>
        </div> -->

      </div>

    </div>
  </div>
</div>


 <!-- Comparing Section  -->

<div *ngIf="compareMode" class="section-card compare-panel">
          <div class="row compare-selects g-4">
            <div class="col-md-6">
              <label>Version A</label>
              <select class="form-control" [value]="compareAId || ''" (change)="onSelectCompareA(+$any($event.target).value)">
                <option value="">Select</option>
                <option *ngFor="let v of getVisibleVersions(); let i = index" [value]="v.id">{{ 'V' + ((versions?.length || 0) - 1 - i) + '_' + idrfq + (isAdmin && isVersionHidden(v?.id) ? ' (Hidden)' : '') }}</option>
              </select>
            </div>
            <div class="col-md-6">
              <label>Version B</label>
              <select class="form-control" [value]="compareBId || ''" (change)="onSelectCompareB(+$any($event.target).value)">
                <option value="">Select</option>
                <option *ngFor="let v of getVisibleVersions(); let i = index" [value]="v.id">{{ 'V' + ((versions?.length || 0) - 1 - i) + '_' + idrfq + (isAdmin && isVersionHidden(v?.id) ? ' (Hidden)' : '') }}</option>
              </select>
            </div>
          </div>
          <div class="row mt-3" *ngIf="compareA && compareB">
            <div class="col-md-12">
              <div class="modern-card compare-card">
                <div class="card-body">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="h6 m-0">Changed Fields</div>
                    <span class="badge bg-primary">{{ changedFields.length }}</span>
                  </div>
                  <ng-container *ngIf="changedFields.length > 0; else noDiff">
                    <div class="diff-row" *ngFor="let f of changedFields">
                      <div class="field-name">{{ compareLabels[f] || f }}</div>
                      <span class="badge value-a">{{ compareA[f] }}</span>
                      <i class="feather icon-arrow-right"></i>
                      <span class="badge value-b">{{ compareB[f] }}</span>
                    </div>
                  </ng-container>
                  <ng-template #noDiff>
                    <div class="text-muted">No differences</div>
                  </ng-template>
                </div>
              </div>
            </div>
          </div>
        </div>

<div class="container">
  <div *ngIf="rfq" class="col-sm-12">
    <div class="row section-card">
      <div class="col-12">


      <!-- En-tête avec RFQ N° et statut affiché en haut à droite -->
      <div class="rfq-title-bar mb-4">
        <div class="rfq-title-left">
          <i class="feather icon-file-text"></i>
          <h2 class="rfq-title">RFQ N°{{ idrfq }}</h2>
        </div>
        <span
          class="badge rounded-pill px-3 py-2 status-badge"
          [ngClass]="{
            'bg-warning text-dark': !rfq.valide && !rfq.rejete,
            'bg-success': rfq.valide,
            'bg-danger': rfq.rejete
          }">
          {{ rfq.valide ? 'Validée' : (rfq.rejete ? 'Rejetée' : 'En attente') }}
        </span>
      </div>


      <!-- Formulaire RFQ en lecture seule -->
      <form [formGroup]="rfqForm">
        <div class="row g-3">
          <!-- Client Section -->
          <div class="row section-card">
            <div class="section-header">
              <i class="feather icon-user"></i>
              <span>Client</span>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Client</label>
                <input type="text" class="form-control" [value]="rfq.client" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>CQ</label>
                <input class="form-control" [value]="rfq.cq" disabled />
              </div>
            </div>
          </div>

          <!-- RFQ Section -->
          <div class="row section-card">
            <div class="section-header">
              <i class="feather icon-file-text"></i>
              <span>RFQ Details</span>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Quote Name</label>
                <input class="form-control" [value]="rfq.quoteName" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Market Segment</label>
                <input class="form-control" [value]="rfq.marketSegment" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Number of ref to be quoted</label>
                <input class="form-control" [value]="rfq.numRefQuoted" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>SOP Date</label>
                <input class="form-control" [value]="rfq.sopDate | date:'yyyy-MM-dd'" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Maximum Value</label>
                <input class="form-control" [value]="rfq.maxV" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Estimated Value</label>
                <input class="form-control" [value]="rfq.estV" disabled />
              </div>
            </div>
          </div>

          <!-- Materials Section -->
          <div class="row section-card">
            <div class="section-header">
              <i class="feather icon-package"></i>
              <span>Materials</span>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>KO Date</label>
                <input class="form-control" [value]="rfq.koDate | date:'yyyy-MM-dd'" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Customer Due Date</label>
                <input class="form-control" [value]="rfq.customerDataDate | date:'yyyy-MM-dd'" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Material Leader</label>
                <input class="form-control" [value]="rfq.materialLeader" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Material Due Date</label>
                <input class="form-control" [value]="rfq.mdDate | date:'yyyy-MM-dd'" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Material Release Date</label>
                <input class="form-control" [value]="rfq.mrDate | date:'yyyy-MM-dd'" disabled />
              </div>
            </div>
          </div>

          <!-- Test Section -->
          <div class="row section-card">
            <div class="section-header">
              <i class="feather icon-activity"></i>
              <span>Test</span>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Test Leader</label>
                <input class="form-control" [value]="rfq.testLeader" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Test Due Date</label>
                <input class="form-control" [value]="rfq.tdDate | date:'yyyy-MM-dd'" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Test Release Date</label>
                <input class="form-control" [value]="rfq.trDate | date:'yyyy-MM-dd'" disabled />
              </div>
            </div>
          </div>

          <!-- VA Section -->
          <div class="row section-card">
            <div class="section-header">
              <i class="feather icon-briefcase"></i>
              <span>VA</span>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>VA Leader</label>
                <input class="form-control" [value]="rfq.vaLeader" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Labour Due Date</label>
                <input class="form-control" [value]="rfq.ldDate | date:'yyyy-MM-dd'" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Labour Release Date</label>
                <input class="form-control" [value]="rfq.lrDate | date:'yyyy-MM-dd'" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Customer Due Date</label>
                <input class="form-control" [value]="rfq.cdDate | date:'yyyy-MM-dd'" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Approval Date</label>
                <input class="form-control" [value]="rfq.approvalDate | date:'yyyy-MM-dd'" disabled />
              </div>
            </div>
            <!-- Replace your current button with this -->
<div class="col-md-4 mb-3" *ngIf="rfq?.fileName">
  <div class="form-group">
    <button type="button" class="btn btn-outline-primary" (click)="downloadFile(rfq.id)">
      <i class="feather icon-download"></i> Download {{rfq.fileName}}
    </button>
  </div>
</div>
          </div>

          <!-- RFQ Engineer Section -->
          <div class="row section-card">
            <div class="section-header">
              <i class="feather icon-user-check"></i>
              <span>RFQ Engineer</span>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>RFQ Engineer</label>
                <input class="form-control" [value]="rfq.ingenieurRFQ" disabled />
              </div>
            </div>
          </div>
        </div>
      </form>
      <br/>
      <hr/>




    </div>


    </div>
  </div>



   <div *ngIf="selectedVersion" class="col-sm-12">
    <div class="row section-card" *ngIf="selectedVersion">
      <div class="col-12">


      <!-- En-tête avec RFQ N° et statut affiché en haut à droite -->
      <div class="rfq-title-bar mb-4">
        <div class="rfq-title-left">
          <i class="feather icon-layers"></i>
          <h2 class="rfq-title">Version V{{ getSelectedVersionDisplayNumber() }} - RFQ N°{{ idrfq }}</h2>
        </div>
        <span
          class="badge rounded-pill px-3 py-2 status-badge"
          [ngClass]="{
            'bg-warning text-dark': !selectedVersion.valide && !selectedVersion.rejete,
            'bg-success': selectedVersion.valide,
            'bg-danger': selectedVersion.rejete
          }">
          {{ selectedVersion.valide ? 'Validée' : (selectedVersion.rejete ? 'Rejetée' : 'En attente') }}
        </span>
      </div>


      <!-- Formulaire selectedVersion en lecture seule -->
      <form [formGroup]="rfqForm">
        <div class="row g-3">
          <!-- Client Section -->
          <div class="row section-card">
            <div class="section-header">
              <i class="feather icon-user"></i>
              <span>Client</span>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Client</label>
                <input type="text" class="form-control" [value]="selectedVersion.client" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>CQ</label>
                <input class="form-control" [value]="selectedVersion.cq" disabled />
              </div>
            </div>
          </div>

          <!-- Version Details Section -->
          <div class="row section-card">
            <div class="section-header">
              <i class="feather icon-file-text"></i>
              <span>Version Details</span>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Quote Name</label>
                <input class="form-control" [value]="selectedVersion.quoteName" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Market Segment</label>
                <input class="form-control" [value]="selectedVersion.marketSegment" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Number of ref to be quoted</label>
                <input class="form-control" [value]="selectedVersion.numRefQuoted" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>SOP Date</label>
                <input class="form-control" [value]="selectedVersion.sopDate | date:'yyyy-MM-dd'" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Maximum Value</label>
                <input class="form-control" [value]="selectedVersion.maxV" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Estimated Value</label>
                <input class="form-control" [value]="selectedVersion.estV" disabled />
              </div>
            </div>
          </div>

          <!-- Materials Section -->
          <div class="row section-card">
            <div class="section-header">
              <i class="feather icon-package"></i>
              <span>Materials</span>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>KO Date</label>
                <input class="form-control" [value]="selectedVersion.koDate | date:'yyyy-MM-dd'" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Customer Due Date</label>
                <input class="form-control" [value]="selectedVersion.customerDataDate | date:'yyyy-MM-dd'" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Material Leader</label>
                <input class="form-control" [value]="selectedVersion.materialLeader" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Material Due Date</label>
                <input class="form-control" [value]="selectedVersion.mdDate | date:'yyyy-MM-dd'" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Material Release Date</label>
                <input class="form-control" [value]="selectedVersion.mrDate | date:'yyyy-MM-dd'" disabled />
              </div>
            </div>
          </div>

          <!-- Test Section -->
          <div class="row section-card">
            <div class="section-header">
              <i class="feather icon-activity"></i>
              <span>Test</span>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Test Leader</label>
                <input class="form-control" [value]="selectedVersion.testLeader" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Test Due Date</label>
                <input class="form-control" [value]="selectedVersion.tdDate | date:'yyyy-MM-dd'" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Test Release Date</label>
                <input class="form-control" [value]="selectedVersion.trDate | date:'yyyy-MM-dd'" disabled />
              </div>
            </div>
          </div>

          <!-- VA Section -->
          <div class="row section-card">
            <div class="section-header">
              <i class="feather icon-briefcase"></i>
              <span>VA</span>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>VA Leader</label>
                <input class="form-control" [value]="selectedVersion.vaLeader" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Labour Due Date</label>
                <input class="form-control" [value]="selectedVersion.ldDate | date:'yyyy-MM-dd'" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Labour Release Date</label>
                <input class="form-control" [value]="selectedVersion.lrDate | date:'yyyy-MM-dd'" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Customer Due Date</label>
                <input class="form-control" [value]="selectedVersion.cdDate | date:'yyyy-MM-dd'" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>Approval Date</label>
                <input class="form-control" [value]="selectedVersion.approvalDate | date:'yyyy-MM-dd'" disabled />
              </div>
            </div>
            <div class="col-md-4 mb-3" *ngIf="selectedVersion.fileName">
              <div class="form-group">
                <button type="button" class="btn btn-outline-primary" (click)="downloadFileV(selectedVersion.id)">
                  <i class="feather icon-download"></i> Download {{selectedVersion.fileName}}
                </button>
              </div>
            </div>
          </div>

          <!-- RFQ Engineer Section -->
          <div class="row section-card">
            <div class="section-header">
              <i class="feather icon-user-check"></i>
              <span>RFQ Engineer</span>
            </div>
            <div class="col-md-4 mb-3">
              <div class="form-group">
                <label>RFQ Engineer</label>
                <input class="form-control" [value]="selectedVersion.ingenieurRFQ" disabled />
              </div>
            </div>
          </div>
        </div>
      </form>
      <br/>
      <hr/>

      </div>
      </div>
   </div>
 <!-- Unified Comments (RFQ or Version) -->

      <div class="col-12">
        <div class="card modern-card comments-card">
          <div class="card-body">
            <h5>Commentaires</h5>
            <hr/>
            <div class="row g-3 align-items-start">
              <!-- Comments list -->
              <div class="col-md-6">
                <div class="card modern-card comments-card"><div class="card-body">
                  <ng-container *ngIf="selectedVersion; else rfqCommentsBlock">
                    <div *ngIf="versionComments && versionComments.length > 0; else noVersionCommentsInline">
                      <ul class="list-group">
                        <li *ngFor="let comment of versionComments" class="list-group-item">
                          <div class="d-flex align-items-center">
                            <img [src]="comment.image || 'assets/images/user/avatar-2.jpg'" class="img-radius me-2"
                                 alt="User-Profile-Image"
                                 style="width: 40px; height: 40px; border-radius: 50%;" />
                            <div class="flex-grow-1 pl-1">
                              <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 text-bold text-primary">{{ comment.nomUser || 'Utilisateur inconnu' }}</h6>
                                <small class="text-muted">{{ comment.dateC | date:'short' }}</small>
                              </div>
                              <label class="mb-0 pt-1 pl-1">{{ comment.contenu }}</label>
                            </div>
                          </div>
                        </li>
                      </ul>
                    </div>
                  </ng-container>
                  <ng-template #rfqCommentsBlock>
                    <div *ngIf="rfqComments && rfqComments.length > 0; else noRFQCommentsUnified">
                      <ul class="list-group">
                        <li *ngFor="let comment of rfqComments" class="list-group-item">
                          <div class="d-flex align-items-center">
                            <img [src]="comment.image || 'assets/images/user/avatar-2.jpg'" class="img-radius me-2"
                                 alt="User-Profile-Image"
                                 style="width: 40px; height: 40px; border-radius: 50%;" />
                            <div class="flex-grow-1 pl-1">
                              <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 text-bold text-primary">{{ comment.nomUser || 'Utilisateur inconnu' }}</h6>
                                <small class="text-muted">{{ comment.dateC | date:'short' }}</small>
                              </div>
                              <label class="mb-0 pt-1 pl-1">{{ comment.contenu }}</label>
                            </div>
                          </div>
                        </li>
                      </ul>
                    </div>
                    <ng-template #noRFQCommentsUnified>
                      <p class="text-muted">No comment for this RFQ.</p>
                    </ng-template>
                  </ng-template>
                  <ng-template #noVersionCommentsInline>
                    <p class="text-muted">No comment for this version.</p>
                  </ng-template>
                </div></div>
              </div>
              <!-- Add comment form (RFQ or Version) -->
              <div class="col-md-6" *ngIf="isValidateur && ((!selectedVersion && !rfq?.valide) || (selectedVersion && !selectedVersion?.valide))">
                <div class="card modern-card comments-card"><div class="card-body">
                  <form class="form-group" [formGroup]="rejectForm">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <label class="mb-0">Write Comment here </label>
                      <button type="button"
                              class="action-expand-btn comment"
                              title="Envoyer commentaire"
                              aria-label="Envoyer commentaire"
                              (click)="selectedVersion ? submitRejectionV() : submitRejection()">
                        <i class="icofont icofont-send-mail"></i>
                  
                      </button>
                    </div>
                    <textarea class="form-control comment-textarea" formControlName="comment" [(ngModel)]="rejectForm.value.comment" rows="3"></textarea>
                  </form>
                </div></div>
              </div>
            </div>
          </div>
        </div>
      </div>

